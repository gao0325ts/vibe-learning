# Database 設計

## 概要

このデータベース設計は、Firebase Firestore を使用した読書進捗管理アプリ向けの NoSQL データモデルを定義します。Firestore は柔軟なスキーマを持つドキュメント指向の NoSQL データベースであるため、伝統的なリレーショナルデータベースとは異なるアプローチを採用しています。

## コレクション構造

### users コレクション

| フィールド名 | データ型  | 説明                                              |
| ------------ | --------- | ------------------------------------------------- |
| uid          | String    | Firebase Authentication から生成されたユーザー ID |
| displayName  | String    | ユーザー表示名                                    |
| email        | String    | メールアドレス                                    |
| photoURL     | String    | プロフィール画像 URL（オプション）                |
| createdAt    | Timestamp | アカウント作成日時                                |
| lastLoginAt  | Timestamp | 最終ログイン日時                                  |
| settings     | Map       | ユーザー設定情報                                  |

### books コレクション

| フィールド名   | データ型  | 説明                         |
| -------------- | --------- | ---------------------------- |
| id             | String    | 書籍 ID（自動生成）          |
| userId         | String    | 所有ユーザーの ID            |
| title          | String    | 書籍タイトル                 |
| author         | String    | 著者名                       |
| totalPages     | Number    | 総ページ数                   |
| currentPage    | Number    | 現在の読了ページ数           |
| progress       | Number    | 読了率（％）                 |
| coverImage     | String    | 表紙画像 URL（オプション）   |
| startDate      | Timestamp | 読書開始日                   |
| lastUpdateDate | Timestamp | 最終更新日                   |
| completionDate | Timestamp | 完読日（オプション）         |
| memo           | String    | メモ・コメント（オプション） |

### reading_logs サブコレクション（books 内）

| フィールド名 | データ型  | 説明                         |
| ------------ | --------- | ---------------------------- |
| id           | String    | ログ ID（自動生成）          |
| bookId       | String    | 対象書籍 ID                  |
| timestamp    | Timestamp | 記録日時                     |
| previousPage | Number    | 以前のページ                 |
| currentPage  | Number    | 更新後のページ               |
| pagesRead    | Number    | 読了ページ数                 |
| readingTime  | Number    | 読書時間（分）（オプション） |

### reading_stats コレクション

| フィールド名     | データ型 | 説明                                   |
| ---------------- | -------- | -------------------------------------- |
| userId           | String   | ユーザー ID                            |
| date             | String   | 日付（YYYY-MM-DD 形式）                |
| totalPagesRead   | Number   | その日の総読了ページ数                 |
| totalReadingTime | Number   | その日の総読書時間（分）（オプション） |
| booksAccessed    | Array    | その日にアクセスした書籍 ID のリスト   |

## インデックス設定

### シングルフィールドインデックス

- books: userId
- books: progress
- reading_stats: userId
- reading_stats: date

### 複合インデックス

- books: [userId, progress]（進捗でのフィルタリング用）
- reading_stats: [userId, date]（期間指定の統計データ取得用）

## データ構造の例

### books ドキュメント例

```json
{
  "id": "book123",
  "userId": "user456",
  "title": "プログラミング言語の基礎",
  "author": "山田太郎",
  "totalPages": 450,
  "currentPage": 120,
  "progress": 26.67,
  "coverImage": "https://storage.example.com/covers/book123.jpg",
  "startDate": {
    "_seconds": 1653566785,
    "_nanoseconds": 0
  },
  "lastUpdateDate": {
    "_seconds": 1653739585,
    "_nanoseconds": 0
  },
  "memo": "第5章から難しくなってきた。コード例をしっかり試すこと"
}
```

## セキュリティルール

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // ユーザーは自分のデータのみアクセス可能
    match /users/{userId} {
      allow read, write: if request.auth.uid == userId;
    }

    // 書籍は所有者のみアクセス可能
    match /books/{bookId} {
      allow read, write: if request.auth.uid == resource.data.userId;
      allow create: if request.auth.uid == request.resource.data.userId;

      // 読書ログも所有者のみアクセス可能
      match /reading_logs/{logId} {
        allow read, write: if request.auth.uid == get(/databases/$(database)/documents/books/$(bookId)).data.userId;
      }
    }

    // 統計データは所有者のみアクセス可能
    match /reading_stats/{statId} {
      allow read, write: if request.auth.uid == resource.data.userId;
      allow create: if request.auth.uid == request.resource.data.userId;
    }
  }
}
```

## データバックアップ戦略

- Firebase 定期エクスポート機能を利用し、Cloud Storage への日次バックアップを設定
- Cloud Functions を使用した重要データの変更監視とバックアップトリガー
- ユーザーデータエクスポート機能の提供（GDPR 対応）

<!-- Generated by Copilot -->

> | name | VARCHAR(50)| NOT NULL |
> | email | VARCHAR(100)| UNIQUE, NOT NULL |
> | password | VARCHAR(255)| NOT NULL |
> | created_at | TIMESTAMP | NOT NULL, DEFAULT now() |
> | updated_at | TIMESTAMP | NOT NULL, DEFAULT now() |

## インデックス

> (例)
>
> ### users テーブル
>
> - email に UNIQUE インデックス

## リレーションシップ

> (例)
>
> ### users テーブル
>
> - users.id → habits.user_id (1:N)

## データベース設計の説明

> (例)
>
> ### habits テーブル
>
> - `description`: ユーザーが入力した習慣の自然言語での説明
> - `action`: AI が抽出した実際の行動（例: 「英語を勉強する」）
